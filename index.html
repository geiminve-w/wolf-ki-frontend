<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Wolf-KI Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="favicon-64.png" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg: #050816;
      --bg-alt: #0b1020;
      --card-bg: #101828;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.15);
      --accent-strong: #0ea5e9;
      --border-subtle: #1f2937;
      --text: #e5e7eb;
      --text-soft: #9ca3af;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #0b1220 0, #020617 45%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .app-root {
      display: flex;
      width: 100%;
      max-width: 1400px;
      min-height: 100vh;
    }

    /* Login Screen */
    #login-screen {
      margin: auto;
      width: 100%;
      max-width: 420px;
      background: #020617;
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow:
        0 35px 80px rgba(15, 23, 42, 0.95),
        0 0 0 1px rgba(148, 163, 184, 0.05);
      padding: 32px 28px 28px;
    }

    .login-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 20px;
    }

    .login-logo {
      width: 48px;
      height: 48px;
      border-radius: 16px;
      background: radial-gradient(circle at 30% 20%, #f9fafb 0, #e5e7eb 30%, #020617 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .login-logo img {
      width: 44px;
      height: 44px;
      object-fit: cover;
    }

    .login-header-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .login-title {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .login-subtitle {
      font-size: 13px;
      color: var(--text-soft);
    }

    .login-card {
      margin-top: 8px;
      border-radius: 18px;
      padding: 18px 16px 16px;
      background: #020617;
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .login-card-title {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
      margin-bottom: 12px;
    }

    .login-form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 14px;
    }

    .login-label {
      font-size: 13px;
      color: var(--text-soft);
    }

    .login-input {
      background: rgba(15, 23, 42, 0.8);
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 8px 10px;
      font-size: 14px;
      color: var(--text);
      outline: none;
    }

    .login-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.2);
    }

    .btn-primary {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 9px 12px;
      font-size: 14px;
      font-weight: 500;
      color: #020617;
      background: linear-gradient(135deg, #38bdf8, #0ea5e9);
      cursor: pointer;
      margin-top: 4px;
    }

    .btn-primary:hover {
      filter: brightness(1.05);
    }

    .login-footer {
      margin-top: 14px;
      font-size: 12px;
      color: var(--text-soft);
      text-align: center;
    }

    .login-error {
      margin-top: 8px;
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(248, 113, 113, 0.08);
      border: 1px solid rgba(248, 113, 113, 0.4);
      font-size: 12px;
      color: #fecaca;
    }

    /* App Shell */
    #app-shell {
      display: none;
      flex: 1;
      max-width: 1400px;
    }

    .sidebar {
      width: 240px;
      padding: 18px 14px;
      background: #020617;
      border-right: 1px solid rgba(51, 65, 85, 0.9);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar-logo {
      width: 40px;
      height: 40px;
      border-radius: 14px;
      overflow: hidden;
      background: radial-gradient(circle at 20% 0, #f9fafb 0, #e5e7eb 30%, #020617 100%);
      border: 1px solid rgba(148, 163, 184, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .sidebar-logo img {
      width: 38px;
      height: 38px;
      object-fit: cover;
    }

    .sidebar-title-main {
      font-weight: 600;
      font-size: 15px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .sidebar-title-sub {
      font-size: 12px;
      color: var(--text-soft);
    }

    .sidebar-nav {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-link {
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 13px;
      border: 1px solid transparent;
      color: var(--text-soft);
      cursor: pointer;
      text-align: left;
    }

    .nav-link.active {
      background: rgba(56, 189, 248, 0.18);
      border-color: rgba(56, 189, 248, 0.6);
      color: #e5e7eb;
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 12px;
      color: var(--text-soft);
      border-radius: 14px;
      padding: 10px 9px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(51, 65, 85, 0.9);
    }

    .sidebar-user-name {
      font-weight: 500;
      color: #e5e7eb;
    }

    .btn-logout {
      margin-top: 8px;
      font-size: 12px;
      padding: 5px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: transparent;
      color: var(--text-soft);
      cursor: pointer;
    }

    .btn-logout:hover {
      background: rgba(148, 163, 184, 0.15);
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #020617;
    }

    .topbar {
      padding: 12px 18px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .topbar-title {
      font-size: 14px;
      font-weight: 500;
      color: #e5e7eb;
    }

    .topbar-sub {
      font-size: 12px;
      color: var(--text-soft);
    }

    .topbar-user {
      font-size: 12px;
      color: var(--text-soft);
    }

    .topbar-user span {
      color: #e5e7eb;
      font-weight: 500;
    }

    .content {
      flex: 1;
      padding: 16px 18px 18px;
      overflow: auto;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
      margin-bottom: 18px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 14px 14px 12px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      box-shadow: 0 14px 40px rgba(15, 23, 42, 0.7);
    }

    .card-title {
      font-size: 13px;
      color: var(--text-soft);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .card-metric {
      font-size: 24px;
      font-weight: 600;
      color: #e5e7eb;
      margin-bottom: 4px;
    }

    .card-hint {
      font-size: 12px;
      color: var(--text-soft);
    }

    .section-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 10px;
      color: #e5e7eb;
    }

    /* Quick actions */
    .quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .quick-btn {
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-soft);
      padding: 4px 8px;
      cursor: pointer;
    }

    .quick-btn:hover {
      border-color: var(--accent);
      color: #e5e7eb;
    }

    /* Views */
    .view {
      width: 100%;
    }

    /* Chat */
    #view-chat {
      display: none;
      height: 100%;
    }

    .chat-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 110px);
      max-height: 700px;
      border-radius: 18px;
      background: #0b1120;
      border: 1px solid rgba(31, 41, 55, 0.9);
      overflow: hidden;
    }

    .chat-messages {
      flex: 1;
      padding: 14px;
      overflow-y: auto;
    }

    .msg-row {
      margin-bottom: 10px;
      display: flex;
    }

    .msg-row.user {
      justify-content: flex-end;
    }

    .msg-bubble {
      max-width: 80%;
      padding: 8px 10px;
      border-radius: 14px;
      font-size: 13px;
      line-height: 1.4;
      white-space: pre-wrap;
    }

    .msg-user {
      background: var(--accent-soft);
      border-bottom-right-radius: 4px;
    }

    .msg-ai {
      background: #020617;
      border: 1px solid rgba(31, 41, 55, 0.9);
      border-bottom-left-radius: 4px;
    }

    .chat-input-area {
      border-top: 1px solid rgba(31, 41, 55, 0.9);
      padding: 10px;
      background: rgba(15, 23, 42, 0.95);
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .chat-input {
      flex: 1;
      resize: none;
      border-radius: 12px;
      border: 1px solid rgba(51, 65, 85, 0.9);
      background: #020617;
      padding: 8px 10px;
      font-size: 13px;
      color: var(--text);
      height: 60px;
    }

    .btn-chat-send {
      border-radius: 999px;
      border: none;
      padding: 9px 14px;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      font-size: 13px;
      cursor: pointer;
      color: #020617;
      font-weight: 500;
    }

    .btn-chat-send:disabled {
      opacity: 0.6;
      cursor: wait;
    }

    /* Memories / History / Tables */
    #view-memories,
    #view-history,
    #view-code,
    #view-upload,
    #view-admin {
      display: none;
    }

    .table-wrapper {
      border-radius: 18px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: #020617;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead {
      background: rgba(15, 23, 42, 0.95);
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
    }

    th {
      text-align: left;
      color: var(--text-soft);
      font-weight: 500;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    @media (max-width: 900px) {
      .sidebar {
        display: none;
      }
      .topbar {
        padding-inline: 12px;
      }
      .content {
        padding-inline: 12px;
      }
      .chat-container {
        height: calc(100vh - 140px);
      }
    }
  </style>
</head>
<body>
  <div class="app-root">
    <!-- LOGIN SCREEN -->
    <div id="login-screen">
      <div class="login-header">
        <div class="login-logo">
          <img src="wolf-avatar-512.png" alt="Wolf-KI" onerror="this.style.display='none'" />
        </div>
        <div class="login-header-text">
          <div class="login-title">Wolf-KI</div>
          <div class="login-subtitle">Pers√∂nlicher Technik- & Recherche-Assistent</div>
        </div>
      </div>

      <div class="login-card">
        <div class="login-card-title">Anmeldung</div>
        <form id="login-form">
          <div class="login-form-group">
            <label class="login-label" for="login-email">E-Mail</label>
            <input id="login-email" class="login-input" type="email" placeholder="z.B. wolf@wolf-ki.local" required />
          </div>
          <div class="login-form-group">
            <label class="login-label" for="login-password">Passwort</label>
            <input id="login-password" class="login-input" type="password" placeholder="Passwort" required />
          </div>
          <button type="submit" class="btn-primary">Einloggen</button>
        </form>
        <div id="login-error" class="login-error" style="display:none;"></div>
      </div>
      <div class="login-footer">
        Supabase Auth + eigenes Wolf-KI Backend (Render)
      </div>
    </div>

    <!-- APP SHELL -->
    <div id="app-shell">
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-logo">
            <img src="wolf-logo-1024.png" alt="Wolf-KI Logo" onerror="this.style.display='none'" />
          </div>
          <div>
            <div class="sidebar-title-main">Wolf-KI</div>
            <div class="sidebar-title-sub">Cloud Assistant</div>
          </div>
        </div>
        <nav class="sidebar-nav">
          <button class="nav-link active" data-view="dashboard">Dashboard</button>
          <button class="nav-link" data-view="chat">Chat</button>
          <button class="nav-link" data-view="history">Verlauf</button>
          <button class="nav-link" data-view="memories">Memories</button>
          <button class="nav-link" data-view="code">Code-Projekte</button>
          <button class="nav-link" data-view="upload">Dateien</button>
          <button class="nav-link" data-view="admin" id="nav-admin" style="display:none;">Benutzer</button>
        </nav>
        <div class="sidebar-footer">
          <div>Angemeldet als</div>
          <div class="sidebar-user-name" id="sidebar-username">-</div>
          <div style="margin-top:2px;">Rolle: <span id="sidebar-role">-</span></div>
          <button class="btn-logout" id="btn-logout">Abmelden</button>
        </div>
      </aside>

      <main class="main">
        <header class="topbar">
          <div>
            <div class="topbar-title">Wolf-KI Dashboard</div>
            <div class="topbar-sub">Recherchen, Auswertungen, Programmierung & Technik-Helfer</div>
          </div>
          <div class="topbar-user">
            Eingeloggt: <span id="topbar-user">-</span>
          </div>
        </header>

        <section class="content">
          <!-- DASHBOARD VIEW -->
          <div id="view-dashboard" class="view">
            <div class="dashboard-grid">
              <div class="card">
                <div class="card-title">Heutige Anfragen</div>
                <div class="card-metric" id="metric-today">0</div>
                <div class="card-hint">Anzahl Requests heute (aus request_log)</div>
              </div>
              <div class="card">
                <div class="card-title">Gesamtanfragen</div>
                <div class="card-metric" id="metric-requests-total">0</div>
                <div class="card-hint">Alle aufgezeichneten Anfragen</div>
              </div>
              <div class="card">
                <div class="card-title">Dokumente / Reports</div>
                <div class="card-metric" id="metric-docs">0</div>
                <div class="card-hint">Gespeicherte Datei- und Bildanalysen</div>
              </div>
            </div>

            <div class="card" style="margin-bottom:10px;">
              <div class="section-title">Letzte Analysen</div>
              <p style="font-size:13px;color:var(--text-soft);margin-bottom:8px;">
                Die letzten hochgeladenen Dateien oder Bilder, die von der Wolf-KI ausgewertet wurden.
              </p>
              <div id="recent-docs-list" style="font-size:13px;color:var(--text-soft);">
                Noch keine Analysen vorhanden.
              </div>
            </div>

            <div class="card" style="margin-bottom:10px;">
              <div class="section-title">Schnellstart-Beispiele</div>
              <p style="font-size:13px;color:var(--text-soft);margin-bottom:6px;">
                Klicke auf eine Vorlage, um direkt im Chat zu starten:
              </p>
              <div class="quick-actions">
                <button class="quick-btn" data-prompt="Bitte korrigiere folgenden Text in Rechtschreibung und Grammatik:" data-mode="proofread" data-lang="de">
                  Text korrigieren (DE)
                </button>
                <button class="quick-btn" data-prompt="Vergleiche bitte Firma A und Firma B im Bereich F√∂rdertechnik. Erstelle eine tabellarische Gegen√ºberstellung mit Pro und Contra." data-mode="normal" data-lang="de">
                  Firmenvergleich F√∂rdertechnik
                </button>
                <button class="quick-btn" data-prompt="Hier ist ein Python-Code. Erkl√§re mir Schritt f√ºr Schritt, was er macht und wo man ihn verbessern kann:" data-mode="technical" data-lang="de">
                  Python-Code erkl√§ren
                </button>
                <button class="quick-btn" data-prompt="Plane eine PV-Anlage mit Batteriespeicher f√ºr ein Einfamilienhaus. Mache Annahmen zur Last, Leistung und Speichergr√∂√üe und gib eine strukturierte Empfehlung." data-mode="technical" data-lang="de">
                  PV + Speicher planen
                </button>
                <button class="quick-btn" data-prompt="Erkl√§re mir eine einfache Trading-Strategie mit klarem Risiko-Management, aber ohne individuelle Anlageberatung." data-mode="normal" data-lang="de">
                  Trading-Strategie erkl√§ren
                </button>
                <button class="quick-btn" data-prompt="Fasse bitte den folgenden englischen Text auf Deutsch zusammen:" data-mode="normal" data-lang="de">
                  Englischen Text zusammenfassen
                </button>
              </div>
            </div>

            <div class="card">
              <div class="section-title">Kurzanleitung & Nutzung</div>
              <p style="font-size:13px;color:var(--text-soft);line-height:1.5;">
                ‚Ä¢ Im Tab <b>Chat</b> kannst du mit verschiedenen Modi arbeiten (Normal, Rechtschreibpr√ºfung, Technik-Experte).<br/>
                ‚Ä¢ Die <b>Antwortsprache</b> kannst du auf Deutsch oder Englisch umstellen, interne Daten (Memories etc.) bleiben Deutsch.<br/>
                ‚Ä¢ Im Tab <b>Dateien</b> kannst du Dokumente und Bilder hochladen und analysieren lassen.<br/>
                ‚Ä¢ √úber <b>Memories</b> siehst du, was sich die Wolf-KI dauerhaft gemerkt hat.<br/>
                ‚Ä¢ √úber <b>Verlauf</b> siehst du deine chronologische Chat-History.<br/>
                ‚Ä¢ √úber <b>Code-Projekte</b> speicherst du komplette Programme, um sp√§ter weiterzumachen.<br/>
                ‚Ä¢ Bisherige Nutzung: <span id="stats-total-requests">0</span> Anfragen, gesch√§tztes Datenvolumen <span id="stats-total-tokens">0</span> Tsd. Token, gespeicherte Memories: <span id="stats-total-memories">0</span>.<br/>
              </p>
              <button id="btn-notify-test" class="quick-btn" style="margin-top:8px;">
                Benachrichtigung testen (‚ÄûIch bin fertig mit der Arbeit‚Äú)
              </button>
            </div>
          </div>

          <!-- CHAT VIEW -->
          <div id="view-chat" class="view" style="display:none;">
            <div class="chat-container">
              <div style="display:flex;gap:8px;align-items:center;padding:8px 10px;border-bottom:1px solid rgba(31,41,55,0.9);background:rgba(15,23,42,0.95);">
                <div style="font-size:12px;color:var(--text-soft);">Modus:</div>
                <select id="chat-mode" style="font-size:12px;background:#020617;color:var(--text);border-radius:8px;border:1px solid rgba(51,65,85,0.9);padding:3px 6px;">
                  <option value="normal">Normal</option>
                  <option value="proofread">Rechtschreibpr√ºfung</option>
                  <option value="technical">Technik-Experte</option>
                </select>
                <div style="font-size:12px;color:var(--text-soft);margin-left:10px;">Antwortsprache:</div>
                <select id="chat-language" style="font-size:12px;background:#020617;color:var(--text);border-radius:8px;border:1px solid rgba(51,65,85,0.9);padding:3px 6px;">
                  <option value="de">Deutsch</option>
                  <option value="en">Englisch</option>
                </select>
                <div style="margin-left:auto;font-size:11px;color:var(--text-soft);">
                  Enter = senden ‚Ä¢ Shift+Enter = Zeilenumbruch
                </div>
              </div>
              <div class="chat-messages" id="chat-messages"></div>
              <div class="chat-input-area">
                <textarea id="chat-input" class="chat-input" placeholder="Frage die Wolf-KI z.B. nach Recherche, Firmenvergleich, F√∂rdertechnik, Smart Home, Trading, Hausbau oder Code-Beispielen‚Ä¶"></textarea>
                <button id="btn-chat-send" class="btn-chat-send">Senden</button>
              </div>
            </div>
          </div>

          <!-- MEMORIES VIEW -->
          <div id="view-memories" class="view" style="display:none;">
            <div class="card" style="margin-bottom:10px;">
              <div class="section-title">Gespeicherte Memories</div>
              <p style="font-size:13px;color:var(--text-soft);">
                Alle Eintr√§ge, bei denen die KI ‚ÄûMERKEN: ‚Ä¶‚Äú erzeugt hat. Grundlage ist die Tabelle <code>memories</code> in Supabase (pro Benutzer gefiltert).
              </p>
            </div>
            <div class="table-wrapper" id="memories-table-wrapper">
              <table id="memories-table">
                <thead>
                  <tr>
                    <th>Datum</th>
                    <th>Typ</th>
                    <th>Inhalt</th>
                    <th>Wichtigkeit</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="4">Noch keine Daten geladen‚Ä¶</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- UPLOAD / DATEIEN VIEW -->
          <div id="view-upload" class="view" style="display:none;">
            <div class="card" style="margin-bottom:12px;">
              <div class="section-title">Dokument / Datei hochladen</div>
              <p style="font-size:13px;color:var(--text-soft);margin-bottom:10px;">
                Lade hier Text-/CSV-/Log-Dateien oder Code-Dateien hoch.
                Die Wolf-KI erstellt eine Zusammenfassung und Empfehlungen.
              </p>
              <input type="file" id="file-doc" />
              <button id="btn-analyze-file" class="btn-primary" style="width:auto;margin-top:8px;">
                Datei analysieren
              </button>
              <pre id="file-result" style="
                  margin-top:10px;
                  font-size:12px;
                  white-space:pre-wrap;
                  background:#020617;
                  border-radius:12px;
                  border:1px solid rgba(31,41,55,0.9);
                  padding:8px 10px;
                  max-height:260px;
                  overflow:auto;
              "></pre>
            </div>

            <div class="card">
              <div class="section-title">Bild hochladen</div>
              <p style="font-size:13px;color:var(--text-soft);margin-bottom:10px;">
                Lade ein Foto von Anlage, Schaltschrank, Skizze oder Dokument hoch.
                Die Wolf-KI gibt dir allgemeine Hinweise und n√§chste Schritte.
              </p>
              <input type="file" id="file-image" accept="image/*" />
              <button id="btn-analyze-image" class="btn-primary" style="width:auto;margin-top:8px;">
                Bild analysieren
              </button>
              <pre id="image-result" style="
                  margin-top:10px;
                  font-size:12px;
                  white-space:pre-wrap;
                  background:#020617;
                  border-radius:12px;
                  border:1px solid rgba(31,41,55,0.9);
                  padding:8px 10px;
                  max-height:260px;
                  overflow:auto;
              "></pre>
            </div>
          </div>

          <!-- HISTORY VIEW -->
          <div id="view-history" class="view" style="display:none;">
            <div class="card" style="margin-bottom:10px;">
              <div class="section-title">Chat-Verlauf</div>
              <p style="font-size:13px;color:var(--text-soft);">
                Hier siehst du deinen bisherigen Verlauf (Fragen & Antworten) in zeitlicher Reihenfolge (aus der Tabelle <code>chat_messages</code>).
              </p>
            </div>
            <div class="table-wrapper">
              <table id="history-table">
                <thead>
                  <tr>
                    <th>Datum</th>
                    <th>Rolle</th>
                    <th>Inhalt</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="3">Noch keine Daten geladen‚Ä¶</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- CODE-PROJEKTE VIEW -->
          <div id="view-code" class="view" style="display:none;">
            <div class="card" style="margin-bottom:10px;">
              <div class="section-title">Code-Projekte</div>
              <p style="font-size:13px;color:var(--text-soft);">
                Hier kannst du komplette Programm-Codes (z.B. Python-Skripte) speichern, laden und sp√§ter weiterbearbeiten. Basis: Tabelle <code>code_projects</code>.
              </p>
            </div>

            <div class="card" style="margin-bottom:10px;">
              <div class="section-title">Meine Projekte</div>
              <div id="code-projects-list" style="font-size:13px;color:var(--text-soft);">
                Noch keine Projekte geladen‚Ä¶
              </div>
            </div>

            <div class="card">
              <div class="section-title">Projekt bearbeiten</div>
              <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:8px;">
                <input id="code-title" type="text" placeholder="Titel des Projekts" style="padding:6px 8px;border-radius:8px;border:1px solid rgba(51,65,85,0.9);background:#020617;color:#e5e7eb;font-size:13px;" />
                <input id="code-language" type="text" placeholder="Sprache (z.B. Python)" style="padding:6px 8px;border-radius:8px;border:1px solid rgba(51,65,85,0.9);background:#020617;color:#e5e7eb;font-size:13px;" />
                <textarea id="code-content" placeholder="Hier deinen Programm-Code einf√ºgen..." style="min-height:200px;padding:8px 10px;border-radius:10px;border:1px solid rgba(51,65,85,0.9);background:#020617;color:#e5e7eb;font-size:12px;font-family:monospace;"></textarea>
              </div>
              <div style="display:flex;gap:8px;">
                <button id="btn-code-new" class="quick-btn">Neues Projekt</button>
                <button id="btn-code-save" class="btn-primary" style="width:auto;">Speichern / Aktualisieren</button>
              </div>
              <div id="code-status" style="margin-top:8px;font-size:12px;color:var(--text-soft);"></div>
            </div>
          </div>

          <!-- ADMIN VIEW -->
          <div id="view-admin" class="view" style="display:none;">
            <div class="card">
              <div class="section-title">Benutzerverwaltung (Platzhalter)</div>
              <p style="font-size:13px;color:var(--text-soft);margin-bottom:10px;">
                Dieser Bereich ist nur f√ºr <b>admin</b>-Benutzer sichtbar (z.B. Wolf).
                Sp√§ter k√∂nnen wir hier Benutzer & Rollen aus <code>user_profile</code> anzeigen und bearbeiten.
              </p>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    // ==== KONFIG ANPASSEN ====
    const API_BASE = "https://wolf-ki-backend.onrender.com";
    const API_URL = API_BASE + "/ask";

    // HIER deine Supabase-Daten eintragen:
    const SUPABASE_URL = "https://psikjgzulbfoyqboskvx.supabase.co";
    const SUPABASE_ANON_KEY = "sb_secret_9h4SWsAFY_HDA5fGVVFgbw_jWS4LetJ";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;

    const loginScreen = document.getElementById("login-screen");
    const appShell = document.getElementById("app-shell");
    const loginForm = document.getElementById("login-form");
    const loginErrorEl = document.getElementById("login-error");

    const sidebarUsername = document.getElementById("sidebar-username");
    const sidebarRole = document.getElementById("sidebar-role");
    const topbarUser = document.getElementById("topbar-user");
    const navAdmin = document.getElementById("nav-admin");
    const btnLogout = document.getElementById("btn-logout");

    const navButtons = document.querySelectorAll(".nav-link");
    const views = {
      dashboard: document.getElementById("view-dashboard"),
      chat: document.getElementById("view-chat"),
      history: document.getElementById("view-history"),
      memories: document.getElementById("view-memories"),
      code: document.getElementById("view-code"),
      upload: document.getElementById("view-upload"),
      admin: document.getElementById("view-admin"),
    };

    const metricTodayEl = document.getElementById("metric-today");
    const metricRequestsTotalEl = document.getElementById("metric-requests-total");
    const metricDocsEl = document.getElementById("metric-docs");
    const recentDocsListEl = document.getElementById("recent-docs-list");

    const statsTotalRequestsEl = document.getElementById("stats-total-requests");
    const statsTotalTokensEl = document.getElementById("stats-total-tokens");
    const statsTotalMemoriesEl = document.getElementById("stats-total-memories");
    const btnNotifyTest = document.getElementById("btn-notify-test");

    const chatMessagesEl = document.getElementById("chat-messages");
    const chatInputEl = document.getElementById("chat-input");
    const chatSendBtn = document.getElementById("btn-chat-send");

    const fileInputDoc = document.getElementById("file-doc");
    const fileResultEl = document.getElementById("file-result");
    const btnAnalyzeFile = document.getElementById("btn-analyze-file");

    const fileInputImage = document.getElementById("file-image");
    const imageResultEl = document.getElementById("image-result");
    const btnAnalyzeImage = document.getElementById("btn-analyze-image");

    const chatModeEl = document.getElementById("chat-mode");
    const chatLanguageEl = document.getElementById("chat-language");

    const quickButtons = document.querySelectorAll(".quick-btn[data-prompt]");

    const historyTableBody = document.querySelector("#history-table tbody");

    const codeProjectsListEl = document.getElementById("code-projects-list");
    const codeTitleEl = document.getElementById("code-title");
    const codeLanguageEl = document.getElementById("code-language");
    const codeContentEl = document.getElementById("code-content");
    const btnCodeNew = document.getElementById("btn-code-new");
    const btnCodeSave = document.getElementById("btn-code-save");
    const codeStatusEl = document.getElementById("code-status");

    let currentChatMode = "normal";
    let currentChatLanguage = "de";
    let currentCodeProjectId = null;

    if (chatModeEl) {
      chatModeEl.addEventListener("change", () => {
        currentChatMode = chatModeEl.value;
      });
    }
    if (chatLanguageEl) {
      chatLanguageEl.addEventListener("change", () => {
        currentChatLanguage = chatLanguageEl.value;
      });
    }

    function showView(viewName) {
      for (const key in views) {
        if (Object.prototype.hasOwnProperty.call(views, key)) {
          views[key].style.display = (key === viewName) ? "block" : "none";
        }
      }
      navButtons.forEach(btn => {
        btn.classList.toggle("active", btn.dataset.view === viewName);
      });
    }

    async function loadDashboardData() {
      try {
        const res = await fetch(API_BASE + "/metrics");
        if (!res.ok) {
          console.warn("Konnte Metrics nicht laden:", res.status);
          return;
        }
        const data = await res.json();
        metricTodayEl.textContent = data.today_requests ?? 0;
        metricRequestsTotalEl.textContent = data.total_requests ?? 0;
        metricDocsEl.textContent = data.total_documents ?? 0;

        if (statsTotalRequestsEl) {
          statsTotalRequestsEl.textContent = data.total_requests ?? 0;
        }
        if (statsTotalTokensEl) {
          const est = data.total_tokens_estimate ?? 0;
          statsTotalTokensEl.textContent = Math.round(est / 1000);
        }
        if (statsTotalMemoriesEl) {
          statsTotalMemoriesEl.textContent = data.total_memories ?? 0;
        }

        if (recentDocsListEl) {
          const docs = data.recent_documents || [];
          if (!docs.length) {
            recentDocsListEl.textContent = "Noch keine Analysen vorhanden.";
          } else {
            recentDocsListEl.innerHTML = "";
            docs.forEach(doc => {
              const div = document.createElement("div");
              const dateStr = doc.created_at
                ? doc.created_at.replace("T", " ").slice(0, 16)
                : "";
              div.textContent = `‚Ä¢ [${doc.doc_type || "doc"}] ${doc.filename || "-"} (${dateStr})`;
              recentDocsListEl.appendChild(div);
            });
          }
        }
      } catch (err) {
        console.error("Fehler beim Laden der Metrics:", err);
      }
    }

    async function loadMemoriesTable() {
      try {
        const userId = currentUser ? currentUser.id : "";
        const res = await fetch(API_BASE + "/memories?limit=50" + (userId ? "&user_id=" + encodeURIComponent(userId) : ""));
        if (!res.ok) {
          console.warn("Konnte Memories nicht laden:", res.status);
          return;
        }
        const data = await res.json();
        const tbody = document.querySelector("#memories-table tbody");
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 4;
          td.textContent = "Noch keine Memories gespeichert.";
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }

        data.forEach(mem => {
          const tr = document.createElement("tr");

          const created = document.createElement("td");
          created.textContent = mem.created_at ? mem.created_at.replace("T", " ").slice(0, 16) : "";
          tr.appendChild(created);

          const typeTd = document.createElement("td");
          typeTd.textContent = mem.type || "";
          tr.appendChild(typeTd);

          const contentTd = document.createElement("td");
          contentTd.textContent = mem.content || "";
          tr.appendChild(contentTd);

          const impTd = document.createElement("td");
          impTd.textContent = (mem.importance != null) ? String(mem.importance) : "";
          tr.appendChild(impTd);

          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("Fehler beim Laden der Memories:", err);
      }
    }

    async function loadHistory() {
      if (!currentUser) return;
      try {
        const res = await fetch(API_BASE + "/history?user_id=" + encodeURIComponent(currentUser.id) + "&limit=100");
        if (!res.ok) {
          console.warn("Konnte Verlauf nicht laden:", res.status);
          return;
        }
        const data = await res.json();
        historyTableBody.innerHTML = "";
        if (!data || data.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 3;
          td.textContent = "Noch kein Verlauf gespeichert.";
          tr.appendChild(td);
          historyTableBody.appendChild(tr);
          return;
        }
        data.forEach(msg => {
          const tr = document.createElement("tr");
          const tdDate = document.createElement("td");
          tdDate.textContent = msg.created_at ? msg.created_at.replace("T", " ").slice(0, 16) : "";
          const tdRole = document.createElement("td");
          tdRole.textContent = msg.role || "";
          const tdContent = document.createElement("td");
          tdContent.textContent = msg.content || "";
          tr.appendChild(tdDate);
          tr.appendChild(tdRole);
          tr.appendChild(tdContent);
          historyTableBody.appendChild(tr);
        });
      } catch (err) {
        console.error("Fehler beim Laden des Verlaufs:", err);
      }
    }

    function addMessage(sender, text) {
      const row = document.createElement("div");
      row.classList.add("msg-row", sender === "user" ? "user" : "ai");
      const bubble = document.createElement("div");
      bubble.classList.add("msg-bubble");
      bubble.classList.add(sender === "user" ? "msg-user" : "msg-ai");
      bubble.textContent = text;
      row.appendChild(bubble);
      chatMessagesEl.appendChild(row);
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    async function sendMessage() {
      const text = chatInputEl.value.trim();
      if (!text) return;
      chatInputEl.value = "";
      addMessage("user", text);
      chatSendBtn.disabled = true;

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message: text,
            mode: currentChatMode,
            target_language: currentChatLanguage,
            user_id: currentUser ? currentUser.id : null,
            user_name: currentUser ? (currentUser.displayName || currentUser.email) : null,
          }),
        });
        if (!res.ok) {
          console.error("Fehler vom /ask-Endpoint:", res.status);
          addMessage("ai", "Fehler bei der Anfrage an das Backend: " + res.status);
        } else {
          const data = await res.json();
          addMessage("ai", data.reply || "(keine Antwort)");
          loadDashboardData();
          loadMemoriesTable();
          loadHistory();
        }
      } catch (err) {
        console.error("Fehler beim Senden:", err);
        addMessage("ai", "Netzwerkfehler beim Senden der Anfrage.");
      } finally {
        chatSendBtn.disabled = false;
        chatInputEl.focus();
      }
    }

    chatSendBtn.addEventListener("click", sendMessage);
    chatInputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    navButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const v = btn.dataset.view;
        showView(v);
        if (v === "dashboard") {
          loadDashboardData();
        } else if (v === "memories") {
          loadMemoriesTable();
        } else if (v === "history") {
          loadHistory();
        } else if (v === "code") {
          loadCodeProjects();
        }
      });
    });

    btnLogout.addEventListener("click", async () => {
      await supabaseClient.auth.signOut();
      currentUser = null;
      appShell.style.display = "none";
      loginScreen.style.display = "block";
      chatMessagesEl.innerHTML = "";
      chatInputEl.value = "";
    });

    async function analyzeFile() {
      const file = fileInputDoc.files && fileInputDoc.files[0];
      if (!file) {
        fileResultEl.textContent = "Bitte zuerst eine Datei ausw√§hlen.";
        return;
      }
      const formData = new FormData();
      formData.append("file", file);
      fileResultEl.textContent = "Analysiere Datei ‚Ä¶";

      try {
        const res = await fetch(API_BASE + "/analyze-file", {
          method: "POST",
          body: formData,
        });
        if (!res.ok) {
          fileResultEl.textContent = "Fehler bei der Analyse: Status " + res.status;
          return;
        }
        const data = await res.json();
        fileResultEl.textContent = data.summary || JSON.stringify(data, null, 2);
        loadDashboardData();
        loadMemoriesTable();
      } catch (err) {
        console.error("Fehler bei Datei-Analyse:", err);
        fileResultEl.textContent = "Netzwerkfehler bei der Datei-Analyse.";
      }
    }

    async function analyzeImage() {
      const file = fileInputImage.files && fileInputImage.files[0];
      if (!file) {
        imageResultEl.textContent = "Bitte zuerst ein Bild ausw√§hlen.";
        return;
      }
      const formData = new FormData();
      formData.append("file", file);
      imageResultEl.textContent = "Analysiere Bild ‚Ä¶";

      try {
        const res = await fetch(API_BASE + "/analyze-image", {
          method: "POST",
          body: formData,
        });
        if (!res.ok) {
          imageResultEl.textContent = "Fehler bei der Analyse: Status " + res.status;
          return;
        }
        const data = await res.json();
        imageResultEl.textContent = data.summary || JSON.stringify(data, null, 2);
        loadDashboardData();
        loadMemoriesTable();
      } catch (err) {
        console.error("Fehler bei Bild-Analyse:", err);
        imageResultEl.textContent = "Netzwerkfehler bei der Bild-Analyse.";
      }
    }

    if (btnAnalyzeFile)  btnAnalyzeFile.addEventListener("click", analyzeFile);
    if (btnAnalyzeImage) btnAnalyzeImage.addEventListener("click", analyzeImage);

    // Schnellstart-Beispiele
    quickButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const prompt = btn.dataset.prompt || "";
        const mode = btn.dataset.mode || "normal";
        const lang = btn.dataset.lang || "de";
        currentChatMode = mode;
        currentChatLanguage = lang;
        if (chatModeEl) chatModeEl.value = mode;
        if (chatLanguageEl) chatLanguageEl.value = lang;
        showView("chat");
        chatInputEl.value = prompt + "\n\n";
        chatInputEl.focus();
      });
    });

    // "Push"-Benachrichtigung testen
    if (btnNotifyTest) {
      btnNotifyTest.addEventListener("click", async () => {
        if (!("Notification" in window)) {
          alert("Browser-Benachrichtigungen werden von deinem Browser nicht unterst√ºtzt.");
          return;
        }
        if (Notification.permission === "granted") {
          new Notification("Wolf-KI", { body: "Erinnerung: Du bist fertig mit der Arbeit. üëç" });
        } else if (Notification.permission !== "denied") {
          const perm = await Notification.requestPermission();
          if (perm === "granted") {
            new Notification("Wolf-KI", { body: "Erinnerung: Du bist fertig mit der Arbeit. üëç" });
          }
        }
      });
    }

    async function loadCodeProjects() {
      if (!currentUser) return;
      codeProjectsListEl.textContent = "Lade Projekte ‚Ä¶";
      try {
        const res = await fetch(API_BASE + "/code-projects?user_id=" + encodeURIComponent(currentUser.id) + "&limit=50");
        if (!res.ok) {
          codeProjectsListEl.textContent = "Fehler beim Laden der Projekte: " + res.status;
          return;
        }
        const data = await res.json();
        if (!data || data.length === 0) {
          codeProjectsListEl.textContent = "Noch keine Projekte vorhanden.";
          return;
        }
        codeProjectsListEl.innerHTML = "";
        data.forEach(proj => {
          const btn = document.createElement("button");
          btn.className = "quick-btn";
          btn.textContent = proj.title || "(Ohne Titel)";
          btn.addEventListener("click", async () => {
            currentCodeProjectId = proj.id;
            codeTitleEl.value = proj.title || "";
            codeLanguageEl.value = proj.language || "";
            codeContentEl.value = proj.content || "";
            codeStatusEl.textContent = "Projekt geladen.";
          });
          codeProjectsListEl.appendChild(btn);
        });
      } catch (err) {
        console.error("Fehler beim Laden der Code-Projekte:", err);
        codeProjectsListEl.textContent = "Fehler beim Laden der Projekte.";
      }
    }

    async function saveCurrentProject() {
      if (!currentUser) {
        codeStatusEl.textContent = "Kein Benutzer angemeldet.";
        return;
      }
      const title = codeTitleEl.value.trim();
      const content = codeContentEl.value;
      if (!title || !content) {
        codeStatusEl.textContent = "Titel und Inhalt d√ºrfen nicht leer sein.";
        return;
      }
      codeStatusEl.textContent = "Speichere Projekt ‚Ä¶";

      try {
        const res = await fetch(API_BASE + "/code-projects", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            id: currentCodeProjectId,
            user_id: currentUser.id,
            title: title,
            description: "",
            language: codeLanguageEl.value.trim(),
            content: content,
          }),
        });
        if (!res.ok) {
          codeStatusEl.textContent = "Fehler beim Speichern: " + res.status;
          return;
        }
        const proj = await res.json();
        currentCodeProjectId = proj.id;
        codeStatusEl.textContent = "Projekt gespeichert.";
        loadCodeProjects();
      } catch (err) {
        console.error("Fehler beim Speichern:", err);
        codeStatusEl.textContent = "Netzwerkfehler beim Speichern.";
      }
    }

    if (btnCodeNew) {
      btnCodeNew.addEventListener("click", () => {
        currentCodeProjectId = null;
        codeTitleEl.value = "";
        codeLanguageEl.value = "";
        codeContentEl.value = "";
        codeStatusEl.textContent = "Neues Projekt angelegt (noch nicht gespeichert).";
      });
    }
    if (btnCodeSave) {
      btnCodeSave.addEventListener("click", saveCurrentProject);
    }

    // LOGIN / AUTH
    loginForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      loginErrorEl.style.display = "none";
      const email = document.getElementById("login-email").value.trim();
      const password = document.getElementById("login-password").value;

      try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error || !data.user) {
          console.error(error);
          loginErrorEl.textContent = "Login fehlgeschlagen. Bitte E-Mail/Passwort pr√ºfen.";
          loginErrorEl.style.display = "block";
          return;
        }

        const user = data.user;

        // Profil aus user_profile holen (auth_user_id, display_name, role)
        const { data: profile, error: profileError } = await supabaseClient
          .from("user_profile")
          .select("display_name, role")
          .eq("auth_user_id", user.id)
          .single();

        if (profileError) {
          console.error(profileError);
          loginErrorEl.textContent = "Profil konnte nicht geladen werden. Pr√ºfe Tabelle user_profile.";
          loginErrorEl.style.display = "block";
          return;
        }

        currentUser = {
          id: user.id,
          email: user.email,
          displayName: profile.display_name,
          role: profile.role,
        };

        loginScreen.style.display = "none";
        appShell.style.display = "flex";

        sidebarUsername.textContent = currentUser.displayName || currentUser.email;
        sidebarRole.textContent = currentUser.role || "-";
        topbarUser.textContent = currentUser.displayName || currentUser.email;

        if (currentUser.role === "admin") {
          navAdmin.style.display = "block";
        } else {
          navAdmin.style.display = "none";
        }

        showView("dashboard");
        loadDashboardData();
        loadMemoriesTable();
        loadHistory();
        loadCodeProjects();

        addMessage("ai", "Hallo " + (currentUser.displayName || "") + " üëã\nDu bist jetzt mit der Wolf-KI Cloud verbunden. Was kann ich f√ºr dich tun?");
      } catch (err) {
        console.error("Login-Fehler:", err);
        loginErrorEl.textContent = "Unerwarteter Fehler beim Login.";
        loginErrorEl.style.display = "block";
      }
    });
  </script>
</body>
</html>
