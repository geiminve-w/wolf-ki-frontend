<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Wolf-KI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Icons / Logos -->
  <link rel="icon" type="image/png" sizes="64x64" href="favicon-64.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="wolf-avatar-512.png" />
  <meta property="og:image" content="wolf-logo-1024.png" />
  <meta name="theme-color" content="#020617" />

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg: #020617;
      --panel: #020617;
      --panel-2: #0b1220;
      --border: rgba(148, 163, 184, 0.22);
      --border-strong: rgba(148, 163, 184, 0.35);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #38bdf8;
      --accent2: #0ea5e9;
      --accent-soft: rgba(56, 189, 248, 0.14);
      --danger: #fca5a5;
      --danger-soft: rgba(248, 113, 113, 0.12);
      --shadow: 0 22px 60px rgba(2, 6, 23, 0.8);
      --radius: 18px;
      --radius2: 24px;
    }

    /* LIGHT THEME */
    [data-theme="light"] {
      --bg: #f8fafc;
      --panel: #ffffff;
      --panel-2: #f1f5f9;
      --border: rgba(2, 6, 23, 0.12);
      --border-strong: rgba(2, 6, 23, 0.18);
      --text: #0f172a;
      --muted: #475569;
      --accent: #0284c7;
      --accent2: #0369a1;
      --accent-soft: rgba(2, 132, 199, 0.12);
      --danger: #b91c1c;
      --danger-soft: rgba(185, 28, 28, 0.10);
      --shadow: 0 18px 50px rgba(15, 23, 42, 0.12);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, -apple-system, "Segoe UI", sans-serif; }
    body {
      background: radial-gradient(circle at top, rgba(56,189,248,0.10) 0, transparent 45%),
                  radial-gradient(circle at bottom, rgba(14,165,233,0.08) 0, transparent 55%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app-root {
      width: 100%;
      max-width: 1680px; /* gr√∂√üer */
      min-height: 100vh;
      display: flex;
    }

    /* LOGIN */
    #login-screen {
      margin: auto;
      width: 100%;
      max-width: 520px;
      background: var(--panel);
      border-radius: var(--radius2);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 30px 26px 24px;
    }

    .login-hero {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-bottom: 18px;
      text-align: center;
    }

    .login-logo-big {
      width: 108px;
      height: 108px;
      border-radius: 999px;
      border: 1px solid var(--border-strong);
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.55) 0, transparent 45%),
                  var(--panel-2);
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
    .login-logo-big img { width: 100%; height: 100%; object-fit: cover; }

    .login-title {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }
    .login-subtitle {
      font-size: 14px;
      color: var(--muted);
    }

    .card {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--panel);
      box-shadow: 0 10px 30px rgba(2,6,23,0.12);
    }

    .login-card {
      padding: 16px 14px 14px;
      background: var(--panel);
    }

    .label { font-size: 13px; color: var(--muted); margin-bottom: 6px; display: block; }
    .input {
      width: 100%;
      background: var(--panel-2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 10px;
      font-size: 14px;
      color: var(--text);
      outline: none;
    }
    .input:focus {
      border-color: rgba(56,189,248,0.8);
      box-shadow: 0 0 0 2px rgba(56,189,248,0.14);
    }

    .row { display: flex; gap: 10px; }
    .col { flex: 1; }

    .btn-primary {
      border: none;
      border-radius: 999px;
      padding: 10px 14px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #02121d;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      width: 100%;
    }
    .btn-primary:disabled { opacity: 0.65; cursor: default; }

    .login-error {
      margin-top: 10px;
      border-radius: 12px;
      border: 1px solid rgba(248,113,113,0.45);
      background: var(--danger-soft);
      color: var(--danger);
      font-size: 12px;
      padding: 8px 10px;
      display: none;
    }

    /* APP */
    #app-shell { display: none; flex: 1; }
    .layout { display: flex; width: 100%; }

    /* LEFT: CHAT LIST / NAV */
    .sidebar {
      width: 280px;
      background: var(--panel);
      border-right: 1px solid var(--border);
      padding: 12px 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 8px;
      border-radius: 16px;
      background: var(--panel-2);
      border: 1px solid var(--border);
    }
    .brand-logo {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid var(--border-strong);
      background: var(--panel);
      flex-shrink: 0;
    }
    .brand-logo img { width: 100%; height: 100%; object-fit: cover; }
    .brand-text { display: flex; flex-direction: column; gap: 2px; }
    .brand-name { font-weight: 700; letter-spacing: 0.10em; text-transform: uppercase; font-size: 14px; }
    .brand-sub { font-size: 12px; color: var(--muted); }

    .sidebar-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .btn-ghost {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      padding: 7px 10px;
      font-size: 12px;
    }
    .btn-ghost:hover { background: rgba(148,163,184,0.12); }

    .btn-newchat {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(56,189,248,0.6);
      background: var(--accent-soft);
      color: var(--text);
      cursor: pointer;
      padding: 8px 10px;
      font-size: 13px;
      font-weight: 600;
    }
    .btn-newchat:hover { background: rgba(56,189,248,0.20); }

    .tabs {
      display: flex;
      gap: 6px;
      padding: 6px;
      background: var(--panel-2);
      border: 1px solid var(--border);
      border-radius: 999px;
    }
    .tab {
      flex: 1;
      border: 1px solid transparent;
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      color: var(--muted);
      background: transparent;
      cursor: pointer;
    }
    .tab.active {
      background: var(--panel);
      border-color: var(--border);
      color: var(--text);
      font-weight: 600;
    }

    .chatlist {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
    }

    .chat-item {
      border: 1px solid transparent;
      border-radius: 14px;
      padding: 8px 8px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 6px;
      background: transparent;
    }
    .chat-item:hover { border-color: var(--border); background: rgba(148,163,184,0.10); }
    .chat-item.active { border-color: rgba(56,189,248,0.6); background: var(--accent-soft); }

    .chat-item-top {
      display: flex;
      gap: 6px;
      align-items: center;
      justify-content: space-between;
    }
    .chat-title {
      font-size: 13px;
      font-weight: 600;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 160px;
    }
    .chat-meta { font-size: 11px; color: var(--muted); }
    .chat-item-actions {
      display: flex;
      gap: 6px;
      align-items: center;
      justify-content: flex-end;
    }
    .iconbtn {
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      font-size: 14px;
      padding: 2px 4px;
      border-radius: 8px;
    }
    .iconbtn:hover { background: rgba(148,163,184,0.14); }
    .iconbtn.danger:hover { background: var(--danger-soft); color: var(--danger); }

    /* MAIN */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    /* TOPBAR */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      background: var(--panel);
    }

    /* only ONE logo in topbar */
    .topbar-left {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 260px;
    }
    .topbar-logo {
      width: 40px;
      height: 40px;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid var(--border-strong);
      background: var(--panel-2);
      flex-shrink: 0;
    }
    .topbar-logo img { width: 100%; height: 100%; object-fit: cover; }

    .topbar-tagline {
      display: flex;
      flex-direction: column;
      gap: 2px;
      line-height: 1.2;
    }
    .topbar-tagline .title {
      font-weight: 800;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      font-size: 13px;
    }
    .topbar-tagline .sub {
      font-size: 12px;
      color: var(--muted);
    }

    .greeting {
      flex: 1;
      text-align: center;
      color: var(--muted);
      font-size: 13px;
    }
    .greeting b { color: var(--text); }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .pill {
      display: flex;
      align-items: center;
      gap: 8px;
      border-radius: 999px;
      padding: 6px 10px;
      border: 1px solid var(--border);
      background: var(--panel-2);
      font-size: 12px;
      color: var(--muted);
    }
    .pill .name { color: var(--text); font-weight: 600; }
    .badge {
      border-radius: 999px;
      padding: 2px 7px;
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 11px;
    }

    .btn-logout {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      padding: 7px 10px;
      cursor: pointer;
      font-size: 12px;
    }
    .btn-logout:hover { background: rgba(148,163,184,0.12); }

    .content {
      flex: 1;
      overflow: auto;
      padding: 12px 14px;
    }

    /* OVERVIEW (merged dashboard+stats) */
    .overview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }
    .metric {
      padding: 12px 12px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--panel);
      box-shadow: 0 12px 30px rgba(2,6,23,0.12);
    }
    .metric .k { font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); }
    .metric .v { font-size: 24px; font-weight: 800; margin-top: 6px; }
    .metric .h { font-size: 12px; color: var(--muted); margin-top: 6px; line-height: 1.3; }

    .panel {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--panel);
      padding: 12px 12px;
      box-shadow: 0 12px 30px rgba(2,6,23,0.10);
      margin-bottom: 10px;
    }

    .panel-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .panel-sub {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
      line-height: 1.35;
    }

    /* Chat */
    .chatbox {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--panel);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 132px);
      min-height: 520px;
      box-shadow: 0 12px 40px rgba(2,6,23,0.16);
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px 12px 6px;
      background: radial-gradient(circle at top, rgba(56,189,248,0.06) 0, transparent 40%), var(--panel);
    }

    .msg-row { display: flex; margin-bottom: 10px; }
    .msg-row.user { justify-content: flex-end; }
    .bubble {
      max-width: 85%;
      padding: 10px 10px;
      border-radius: 14px;
      font-size: 13px;
      line-height: 1.45;
      white-space: pre-wrap;
      border: 1px solid transparent;
    }
    .bubble.user {
      background: var(--accent-soft);
      border-color: rgba(56,189,248,0.30);
      border-bottom-right-radius: 5px;
    }
    .bubble.ai {
      background: var(--panel-2);
      border-color: var(--border);
      border-bottom-left-radius: 5px;
    }
    .meta {
      font-size: 10px;
      color: var(--muted);
      margin-bottom: 2px;
    }

    .composer {
      border-top: 1px solid var(--border);
      padding: 10px;
      background: var(--panel);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .composer-row { display: flex; gap: 8px; align-items: flex-end; }
    textarea {
      flex: 1;
      resize: none;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--panel-2);
      padding: 10px 10px;
      font-size: 13px;
      color: var(--text);
      height: 70px;
      outline: none;
    }
    textarea:focus {
      border-color: rgba(56,189,248,0.8);
      box-shadow: 0 0 0 2px rgba(56,189,248,0.12);
    }

    .sendcol { display: flex; flex-direction: column; gap: 6px; }
    .btn-send {
      border: none;
      border-radius: 999px;
      padding: 10px 14px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #02121d;
      font-weight: 700;
      cursor: pointer;
      font-size: 13px;
    }
    .btn-send:disabled { opacity: 0.65; cursor: wait; }

    .btn-small {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      padding: 6px 10px;
      cursor: pointer;
      font-size: 12px;
    }
    .btn-small:hover { background: rgba(148,163,184,0.12); }

    .attach-row {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }
    .attach-left {
      display: flex;
      gap: 8px;
      align-items: center;
      color: var(--muted);
      font-size: 12px;
      flex: 1;
      min-width: 0;
    }
    .filelabel {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 7px 10px;
      cursor: pointer;
      background: var(--panel-2);
      white-space: nowrap;
    }
    .filelabel:hover { background: rgba(148,163,184,0.14); }
    #file-input { display: none; }

    .dropzone {
      flex: 1;
      min-width: 0;
      border-radius: 999px;
      border: 1px dashed var(--border-strong);
      padding: 7px 10px;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .dropzone.dragover {
      border-style: solid;
      border-color: rgba(56,189,248,0.85);
      background: rgba(56,189,248,0.10);
      color: var(--text);
    }

    /* Settings + System */
    .formgrid { display: grid; grid-template-columns: 1fr; gap: 10px; max-width: 720px; }
    .hr { height: 1px; background: var(--border); border: none; margin: 10px 0; }

    .kv {
      display: grid;
      grid-template-columns: 220px 1fr;
      gap: 10px;
      font-size: 13px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }
    .kv .k { color: var(--muted); }
    .kv .v { color: var(--text); word-break: break-word; }

    /* Responsive */
    @media (max-width: 980px) {
      .sidebar { display: none; }
      .topbar-left { min-width: 0; }
      .greeting { display: none; }
      .content { padding: 10px; }
      .chatbox { height: calc(100vh - 120px); }
    }

    @media (max-width: 640px) {
      #login-screen { margin: 14px; max-width: 100%; }
      .login-logo-big { width: 92px; height: 92px; }
      textarea { height: 60px; }
      .composer { position: sticky; bottom: 0; }
      .topbar-tagline .sub { display: none; }
    }
  </style>
</head>

<body>
  <div class="app-root">

    <!-- LOGIN -->
    <div id="login-screen">
      <div class="login-hero">
        <div class="login-logo-big">
          <!-- LOGO OHNE TEXT (nur Wolf) -->
          <img src="wolf-avatar-512.png" alt="Wolf-KI" />
        </div>
        <div class="login-title">Wolf-KI</div>
        <div class="login-subtitle">Dein pers√∂nlicher Recherche-Assistent</div>
      </div>

      <div class="card login-card">
        <form id="login-form" autocomplete="off">
          <div style="margin-bottom:12px;">
            <label class="label" for="email">E-Mail</label>
            <input id="email" class="input" type="email" autocomplete="off" required />
          </div>
          <div style="margin-bottom:12px;">
            <label class="label" for="password">Passwort</label>
            <input id="password" class="input" type="password" autocomplete="new-password" required />
          </div>
          <button id="login-btn" class="btn-primary" type="submit">Einloggen</button>
        </form>
        <div id="login-error" class="login-error"></div>
      </div>
    </div>

    <!-- APP -->
    <div id="app-shell">
      <div class="layout">

        <!-- LEFT SIDEBAR -->
        <aside class="sidebar">
          <div class="brand">
            <div class="brand-logo">
              <img src="wolf-logo-1024.png" alt="Wolf" />
            </div>
            <div class="brand-text">
              <div class="brand-name">Wolf-KI</div>
              <div class="brand-sub">Dein pers√∂nlicher Recherche-Assistent</div>
            </div>
          </div>

          <div class="sidebar-actions">
            <button id="btn-new-chat" class="btn-newchat">Neuer Chat</button>
            <button id="btn-toggle-sidebar" class="btn-ghost" title="Sidebar ein/aus (mobil)">
              ‚ò∞
            </button>
          </div>

          <div class="tabs">
            <button class="tab active" data-tab="all">Chats</button>
            <button class="tab" data-tab="archived">Archiv</button>
          </div>

          <div id="chat-list" class="chatlist"></div>

          <div class="panel" style="padding:10px;">
            <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;">
              <button class="btn-small" id="nav-overview">√úbersicht</button>
              <button class="btn-small" id="nav-settings">Einstellungen</button>
              <button class="btn-small" id="nav-system">System</button>
            </div>
          </div>
        </aside>

        <!-- MAIN -->
        <main class="main">
          <header class="topbar">
            <div class="topbar-left">
              <!-- NUR EIN LOGO -->
              <div class="topbar-logo">
                <img src="wolf-logo-1024.png" alt="Wolf" />
              </div>
              <div class="topbar-tagline">
                <div class="title">Wolf-KI</div>
                <div class="sub">Dein pers√∂nlicher Recherche-Assistent</div>
              </div>
            </div>

            <div class="greeting" id="greeting">
              Hallo <b id="greeting-name">Benutzer</b>, sch√∂n dass du da bist. Wie kann ich dich heute unterst√ºtzen?
            </div>

            <div class="topbar-right">
              <div class="pill">
                <span class="name" id="user-name">-</span>
                <span class="badge" id="user-role">-</span>
              </div>
              <button id="btn-logout" class="btn-logout">Abmelden</button>
            </div>
          </header>

          <section class="content">
            <!-- OVERVIEW (Dashboard+Stats merged) -->
            <div id="view-overview" style="display:none;">
              <div class="overview-grid">
                <div class="metric">
                  <div class="k">Anfragen heute</div>
                  <div class="v" id="m-today">0</div>
                  <div class="h">Anfragen an Wolf-KI am heutigen Tag.</div>
                </div>
                <div class="metric">
                  <div class="k">Gesamtanfragen</div>
                  <div class="v" id="m-total">0</div>
                  <div class="h">Alle Anfragen seit Start.</div>
                </div>
                <div class="metric">
                  <div class="k">Memories</div>
                  <div class="v" id="m-memories">0</div>
                  <div class="h">Gespeicherte Notizen/Infos.</div>
                </div>
                <div class="metric">
                  <div class="k">Code-Projekte</div>
                  <div class="v" id="m-code">0</div>
                  <div class="h">Gespeicherte Programme/Projekte.</div>
                </div>
              </div>

              <div class="panel">
                <div class="panel-title">Aktivit√§t</div>
                <div class="panel-sub">Basiswerte aus dem Backend (weitere Diagramme bauen wir im n√§chsten Schritt aus).</div>
                <div id="overview-extra" style="font-size:13px;color:var(--muted);line-height:1.5;">
                  Lade Daten‚Ä¶
                </div>
              </div>
            </div>

            <!-- CHAT (default after login) -->
            <div id="view-chat" style="display:block;">
              <div class="chatbox">
                <div class="messages" id="messages"></div>

                <div class="composer">
                  <div class="composer-row">
                    <textarea id="prompt" placeholder="Stell mir eine Frage oder gib mir eine Aufgabe (z. B. Firmen vergleichen, Programmierung, Dokumente auswerten, Recherche zusammenfassen) ‚Ä¶"></textarea>
                    <div class="sendcol">
                      <button id="btn-send" class="btn-send">Senden</button>
                      <button id="btn-export" class="btn-small">Chat exportieren</button>
                    </div>
                  </div>

                  <div class="attach-row">
                    <div class="attach-left">
                      <label class="filelabel" for="file-input">+ Datei</label>
                      <input id="file-input" type="file" multiple />
                      <div id="dropzone" class="dropzone">Dateien hier ablegen (Drag & Drop)‚Ä¶</div>
                    </div>
                    <div style="font-size:12px;color:var(--muted);white-space:nowrap;">
                      Auto-Logout: 15 min
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- SETTINGS -->
            <div id="view-settings" style="display:none;">
              <div class="panel">
                <div class="panel-title">Einstellungen</div>
                <div class="panel-sub">Theme umschalten und Passwort √§ndern.</div>

                <div class="formgrid">
                  <div class="panel" style="margin-bottom:0;">
                    <div class="panel-title" style="margin-bottom:6px;">Theme</div>
                    <div class="row" style="align-items:center;">
                      <div class="col" style="color:var(--muted);font-size:13px;">
                        Hell / Dunkel Umschaltung
                      </div>
                      <div class="col" style="display:flex;justify-content:flex-end;">
                        <button id="btn-theme" class="btn-small">Theme wechseln</button>
                      </div>
                    </div>
                  </div>

                  <div class="panel" style="margin-bottom:0;">
                    <div class="panel-title" style="margin-bottom:6px;">Passwort √§ndern</div>
                    <div class="panel-sub" style="margin-bottom:10px;">
                      Du bist angemeldet. Hier kannst du dein Passwort direkt √ºber Supabase √§ndern.
                    </div>

                    <label class="label" for="newpass">Neues Passwort</label>
                    <input id="newpass" class="input" type="password" autocomplete="new-password" />

                    <div style="height:10px;"></div>

                    <button id="btn-pass" class="btn-primary" type="button">Passwort aktualisieren</button>
                    <div id="pass-status" style="margin-top:8px;font-size:12px;color:var(--muted);"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- SYSTEM -->
            <div id="view-system" style="display:none;">
              <div class="panel">
                <div class="panel-title">System-Infos</div>
                <div class="panel-sub">√úbersicht zur laufenden Cloud-Instanz (ohne sensible Schl√ºssel).</div>
                <div id="sys-kv"></div>
              </div>
            </div>

          </section>
        </main>
      </div>
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    const API_BASE = "https://wolf-ki-backend.onrender.com";

    // Supabase:
    const SUPABASE_URL = "https://psikjgzulbfoyqboskvx.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_SWSd1MDNHi5cBJjzrf_bCQ_H0JCgkwX"; // <-- HIER einsetzen!

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ========= STATE =========
    let currentUser = null;
    let currentProfile = null;

    // chats stored local (Step A). Later: server-side chat_sessions table.
    let chats = [];
    let activeChatId = null;
    let currentTab = "all"; // all | archived

    // inactivity auto logout
    const AUTO_LOGOUT_MIN = 15;
    let inactivityTimer = null;

    // ========= DOM =========
    const loginScreen = document.getElementById("login-screen");
    const appShell = document.getElementById("app-shell");
    const loginForm = document.getElementById("login-form");
    const loginError = document.getElementById("login-error");
    const loginBtn = document.getElementById("login-btn");
    const emailEl = document.getElementById("email");
    const passwordEl = document.getElementById("password");

    const greetingName = document.getElementById("greeting-name");
    const userName = document.getElementById("user-name");
    const userRole = document.getElementById("user-role");
    const btnLogout = document.getElementById("btn-logout");

    const viewChat = document.getElementById("view-chat");
    const viewOverview = document.getElementById("view-overview");
    const viewSettings = document.getElementById("view-settings");
    const viewSystem = document.getElementById("view-system");

    const btnNewChat = document.getElementById("btn-new-chat");
    const chatListEl = document.getElementById("chat-list");
    const tabBtns = document.querySelectorAll(".tab");

    const navOverview = document.getElementById("nav-overview");
    const navSettings = document.getElementById("nav-settings");
    const navSystem = document.getElementById("nav-system");

    const messagesEl = document.getElementById("messages");
    const promptEl = document.getElementById("prompt");
    const btnSend = document.getElementById("btn-send");
    const btnExport = document.getElementById("btn-export");

    const fileInput = document.getElementById("file-input");
    const dropzone = document.getElementById("dropzone");

    const mToday = document.getElementById("m-today");
    const mTotal = document.getElementById("m-total");
    const mMemories = document.getElementById("m-memories");
    const mCode = document.getElementById("m-code");
    const overviewExtra = document.getElementById("overview-extra");

    const btnTheme = document.getElementById("btn-theme");
    const btnPass = document.getElementById("btn-pass");
    const newPass = document.getElementById("newpass");
    const passStatus = document.getElementById("pass-status");

    const sysKv = document.getElementById("sys-kv");

    // ========= THEME =========
    function loadTheme() {
      const t = localStorage.getItem("wolf_theme") || "dark";
      document.documentElement.setAttribute("data-theme", t);
      document.querySelector('meta[name="theme-color"]').setAttribute("content", t === "light" ? "#ffffff" : "#020617");
    }
    function toggleTheme() {
      const current = document.documentElement.getAttribute("data-theme") || "dark";
      const next = current === "light" ? "dark" : "light";
      localStorage.setItem("wolf_theme", next);
      loadTheme();
    }
    loadTheme();
    btnTheme.addEventListener("click", toggleTheme);

    // ========= VIEWS =========
    function showOnly(which) {
      viewChat.style.display = which === "chat" ? "block" : "none";
      viewOverview.style.display = which === "overview" ? "block" : "none";
      viewSettings.style.display = which === "settings" ? "block" : "none";
      viewSystem.style.display = which === "system" ? "block" : "none";
    }

    navOverview.addEventListener("click", async () => {
      showOnly("overview");
      await loadMetrics();
    });
    navSettings.addEventListener("click", () => showOnly("settings"));
    navSystem.addEventListener("click", async () => {
      showOnly("system");
      await loadSystemInfo();
    });

    // ========= AUTO LOGOUT =========
    function resetInactivityTimer() {
      if (!currentUser) return;
      if (inactivityTimer) clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(() => logout(true), AUTO_LOGOUT_MIN * 60 * 1000);
    }
    ["click","keydown","mousemove","touchstart"].forEach(evt => {
      window.addEventListener(evt, () => resetInactivityTimer(), { passive: true });
    });

    async function logout(auto=false) {
      try { await supabaseClient.auth.signOut(); } catch {}
      currentUser = null;
      currentProfile = null;
      appShell.style.display = "none";
      loginScreen.style.display = "block";
      if (auto) {
        loginError.textContent = "Du wurdest nach Inaktivit√§t automatisch abgemeldet.";
        loginError.style.display = "block";
      }
    }
    btnLogout.addEventListener("click", () => logout(false));

    // ========= CHAT LIST (local for Step A) =========
    function loadChats() {
      const key = currentUser ? `wolf_chats_${currentUser.id}` : "wolf_chats_guest";
      try {
        chats = JSON.parse(localStorage.getItem(key) || "[]");
      } catch { chats = []; }

      if (!chats.length) {
        const id = "chat-" + Date.now();
        chats.push({ id, title: "Neuer Chat", archived: false, lastAccess: new Date().toISOString() });
        activeChatId = id;
        saveChats();
      } else {
        if (!activeChatId || !chats.some(c => c.id === activeChatId)) {
          activeChatId = chats[0].id;
        }
      }
      renderChatList();
    }

    function saveChats() {
      const key = currentUser ? `wolf_chats_${currentUser.id}` : "wolf_chats_guest";
      localStorage.setItem(key, JSON.stringify(chats));
    }

    function setActiveChat(id) {
      activeChatId = id;
      const c = chats.find(x => x.id === id);
      if (c) c.lastAccess = new Date().toISOString();
      saveChats();
      renderChatList();
      loadChatMessages(); // local messages for step A
      showOnly("chat");
    }

    function renderChatList() {
      chatListEl.innerHTML = "";
      const filtered = chats.filter(c => (currentTab === "archived" ? c.archived : !c.archived));
      if (!filtered.length) {
        const div = document.createElement("div");
        div.style.color = "var(--muted)";
        div.style.fontSize = "13px";
        div.style.padding = "10px";
        div.textContent = currentTab === "archived" ? "Noch keine archivierten Chats." : "Noch keine Chats.";
        chatListEl.appendChild(div);
        return;
      }

      filtered
        .sort((a,b) => (b.lastAccess || "").localeCompare(a.lastAccess || ""))
        .forEach(c => {
          const item = document.createElement("div");
          item.className = "chat-item" + (c.id === activeChatId ? " active" : "");
          item.addEventListener("click", () => setActiveChat(c.id));

          const top = document.createElement("div");
          top.className = "chat-item-top";

          const title = document.createElement("div");
          title.className = "chat-title";
          title.textContent = c.title || "Chat";

          const date = document.createElement("div");
          date.className = "chat-meta";
          date.textContent = c.lastAccess ? new Date(c.lastAccess).toLocaleString() : "-";

          top.appendChild(title);
          top.appendChild(date);

          const actions = document.createElement("div");
          actions.className = "chat-item-actions";

          const btnRename = document.createElement("button");
          btnRename.className = "iconbtn";
          btnRename.title = "Umbenennen";
          btnRename.textContent = "‚úé";
          btnRename.addEventListener("click", (e) => {
            e.stopPropagation();
            const t = prompt("Neuer Name:", c.title || "Chat");
            if (t != null && t.trim()) {
              c.title = t.trim();
              saveChats();
              renderChatList();
            }
          });

          const btnArchive = document.createElement("button");
          btnArchive.className = "iconbtn";
          btnArchive.title = c.archived ? "Entarchivieren" : "Archivieren";
          btnArchive.textContent = c.archived ? "‚Ü©" : "üì¶";
          btnArchive.addEventListener("click", (e) => {
            e.stopPropagation();
            c.archived = !c.archived;
            saveChats();
            renderChatList();
          });

          const btnDelete = document.createElement("button");
          btnDelete.className = "iconbtn danger";
          btnDelete.title = "L√∂schen";
          btnDelete.textContent = "üóë";
          btnDelete.addEventListener("click", (e) => {
            e.stopPropagation();
            if (!confirm("Diesen Chat wirklich l√∂schen?")) return;
            deleteChat(c.id);
          });

          actions.appendChild(btnRename);
          actions.appendChild(btnArchive);
          actions.appendChild(btnDelete);

          item.appendChild(top);
          item.appendChild(actions);
          chatListEl.appendChild(item);
        });
    }

    function deleteChat(id) {
      chats = chats.filter(c => c.id !== id);
      if (!chats.length) {
        const nid = "chat-" + Date.now();
        chats.push({ id: nid, title: "Neuer Chat", archived: false, lastAccess: new Date().toISOString() });
        activeChatId = nid;
      } else if (activeChatId === id) {
        activeChatId = chats[0].id;
      }
      saveChats();
      renderChatList();
      loadChatMessages();
    }

    tabBtns.forEach(b => {
      b.addEventListener("click", () => {
        tabBtns.forEach(x => x.classList.remove("active"));
        b.classList.add("active");
        currentTab = b.dataset.tab;
        renderChatList();
      });
    });

    btnNewChat.addEventListener("click", () => {
      const id = "chat-" + Date.now();
      chats.push({ id, title: "Neuer Chat", archived: false, lastAccess: new Date().toISOString() });
      saveChats();
      setActiveChat(id);
      clearChatMessages();
      addMsg("ai", `Hallo üëã\nStarte einfach ‚Äì du kannst auch Dateien direkt hier hochladen.`);
    });

    // ========= LOCAL CHAT MESSAGES (Step A) =========
    function msgKey() {
      return currentUser ? `wolf_msgs_${currentUser.id}_${activeChatId}` : `wolf_msgs_guest_${activeChatId}`;
    }

    function loadChatMessages() {
      messagesEl.innerHTML = "";
      let arr = [];
      try { arr = JSON.parse(localStorage.getItem(msgKey()) || "[]"); } catch {}
      if (!arr.length) {
        addMsg("ai", `Hallo üëã\nWie kann ich dich heute unterst√ºtzen?`);
        saveCurrentMsgs();
      } else {
        arr.forEach(m => renderMsg(m.role, m.text, m.meta || ""));
      }
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function getCurrentMsgs() {
      try { return JSON.parse(localStorage.getItem(msgKey()) || "[]"); } catch { return []; }
    }

    function saveCurrentMsgs() {
      const arr = [];
      messagesEl.querySelectorAll(".msg-row").forEach(row => {
        const role = row.classList.contains("user") ? "user" : "ai";
        const bubble = row.querySelector(".bubble");
        const meta = row.querySelector(".meta");
        arr.push({ role, text: bubble ? bubble.textContent : "", meta: meta ? meta.textContent : "" });
      });
      localStorage.setItem(msgKey(), JSON.stringify(arr));
    }

    function clearChatMessages() {
      localStorage.removeItem(msgKey());
      messagesEl.innerHTML = "";
    }

    function renderMsg(role, text, meta="") {
      const row = document.createElement("div");
      row.className = "msg-row " + (role === "user" ? "user" : "ai");

      const col = document.createElement("div");

      if (meta) {
        const m = document.createElement("div");
        m.className = "meta";
        m.textContent = meta;
        col.appendChild(m);
      }

      const bubble = document.createElement("div");
      bubble.className = "bubble " + (role === "user" ? "user" : "ai");
      bubble.textContent = text;

      col.appendChild(bubble);
      row.appendChild(col);
      messagesEl.appendChild(row);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function addMsg(role, text, meta="") {
      renderMsg(role, text, meta);
      saveCurrentMsgs();
    }

    // ========= API CALLS =========
    async function sendPrompt() {
      const text = (promptEl.value || "").trim();
      if (!text) return;

      promptEl.value = "";
      addMsg("user", text);

      btnSend.disabled = true;

      try {
        const res = await fetch(API_BASE + "/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message: text,
            mode: "normal",
            target_language: "de",
            user_id: currentUser ? currentUser.id : null,
            user_name: currentProfile ? (currentProfile.display_name || currentUser.email) : null,
            session_id: activeChatId || "default",
          })
        });

        if (!res.ok) {
          addMsg("ai", "Fehler bei der Anfrage: Status " + res.status);
        } else {
          const data = await res.json();
          addMsg("ai", data.reply || "(keine Antwort)");
          await loadMetrics();
        }
      } catch (e) {
        addMsg("ai", "Netzwerkfehler beim Senden der Anfrage.");
      } finally {
        btnSend.disabled = false;
        promptEl.focus();
      }
    }

    btnSend.addEventListener("click", sendPrompt);
    promptEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendPrompt();
      }
    });

    btnExport.addEventListener("click", () => {
      const text = messagesEl.innerText || "";
      if (!text.trim()) return alert("Noch keine Nachrichten.");
      const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `wolf-ki-chat-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // ========= FILE UPLOAD IN CHAT =========
    function handleFiles(files) {
      if (!files || !files.length) return;
      Array.from(files).forEach((file) => {
        addMsg("user", `[Datei: ${file.name}]`);
        const isImage = file.type.startsWith("image/");
        const endpoint = isImage ? "/analyze-image" : "/analyze-file";

        addMsg("ai", `Analysiere ${file.name} ‚Ä¶`, "Dateianalyse");

        const formData = new FormData();
        formData.append("file", file);

        fetch(API_BASE + endpoint, { method: "POST", body: formData })
          .then(r => {
            if (!r.ok) throw new Error("Status " + r.status);
            return r.json();
          })
          .then(data => addMsg("ai", data.summary || JSON.stringify(data, null, 2), "Analyse"))
          .catch(err => addMsg("ai", `Fehler bei Analyse: ${err.message}`, "Analyse"));
      });
    }

    fileInput.addEventListener("change", (e) => {
      handleFiles(e.target.files);
      fileInput.value = "";
    });

    dropzone.addEventListener("dragover", (e) => { e.preventDefault(); dropzone.classList.add("dragover"); });
    dropzone.addEventListener("dragleave", () => dropzone.classList.remove("dragover"));
    dropzone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropzone.classList.remove("dragover");
      handleFiles(e.dataTransfer.files);
    });

    // ========= METRICS / SYSTEM =========
    async function loadMetrics() {
      try {
        const res = await fetch(API_BASE + "/metrics");
        if (!res.ok) return;
        const data = await res.json();
        mToday.textContent = data.today_requests ?? 0;
        mTotal.textContent = data.total_requests ?? 0;
        mMemories.textContent = data.total_memories ?? 0;
        mCode.textContent = data.total_code_projects ?? 0;

        overviewExtra.innerHTML =
          `Request-Log Tabelle: <b>${data.request_log_table || "request_log"}</b><br>` +
          `Hinweis: Weitere Diagramme und detaillierte Statistiken erweitern wir im n√§chsten Schritt.`;
      } catch {}
    }

    async function loadSystemInfo() {
      try {
        const res = await fetch(API_BASE + "/system-info");
        if (!res.ok) return;
        const data = await res.json();
        sysKv.innerHTML = "";
        Object.keys(data).forEach(k => {
          const row = document.createElement("div");
          row.className = "kv";
          row.innerHTML = `<div class="k">${k}</div><div class="v">${String(data[k])}</div>`;
          sysKv.appendChild(row);
        });
      } catch {}
    }

    // ========= PASSWORD CHANGE =========
    btnPass.addEventListener("click", async () => {
      const pw = (newPass.value || "").trim();
      if (!pw) {
        passStatus.textContent = "Bitte ein neues Passwort eingeben.";
        return;
      }
      passStatus.textContent = "Aktualisiere Passwort‚Ä¶";
      try {
        const { error } = await supabaseClient.auth.updateUser({ password: pw });
        if (error) {
          passStatus.textContent = "Fehler: " + error.message;
        } else {
          passStatus.textContent = "Passwort wurde aktualisiert.";
          newPass.value = "";
        }
      } catch (e) {
        passStatus.textContent = "Unerwarteter Fehler beim Passwort-Update.";
      }
    });

    // ========= LOGIN FLOW =========
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      loginError.style.display = "none";
      loginBtn.disabled = true;

      try {
        const email = (emailEl.value || "").trim();
        const password = passwordEl.value || "";

        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error || !data.user) {
          loginError.textContent = "Login fehlgeschlagen. Bitte E-Mail/Passwort pr√ºfen.";
          loginError.style.display = "block";
          return;
        }
        await afterLogin(data.user);
      } catch {
        loginError.textContent = "Unerwarteter Fehler beim Login.";
        loginError.style.display = "block";
      } finally {
        loginBtn.disabled = false;
      }
    });

    async function afterLogin(user) {
      const { data: profile, error } = await supabaseClient
        .from("user_profile")
        .select("display_name, role")
        .eq("auth_user_id", user.id)
        .single();

      if (error) {
        loginError.textContent = "Profil konnte nicht geladen werden. Pr√ºfe Tabelle user_profile.";
        loginError.style.display = "block";
        return;
      }

      currentUser = user;
      currentProfile = profile;

      const display = profile.display_name || user.email || "Benutzer";

      greetingName.textContent = display;
      userName.textContent = display;
      userRole.textContent = profile.role || "-";

      loginScreen.style.display = "none";
      appShell.style.display = "flex";

      // Step A: Start direkt im Chat
      showOnly("chat");

      // chats laden
      loadChats();
      setActiveChat(activeChatId);

      // metrics/system laden (lazy)
      loadMetrics();

      resetInactivityTimer();
    }

    async function checkSession() {
      try {
        const { data } = await supabaseClient.auth.getUser();
        if (data && data.user) {
          await afterLogin(data.user);
        } else {
          loginScreen.style.display = "block";
          appShell.style.display = "none";
        }
      } catch {
        loginScreen.style.display = "block";
        appShell.style.display = "none";
      }
    }

    // Start
    checkSession();
  </script>
</body>
</html>
